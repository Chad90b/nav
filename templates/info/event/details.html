{% extends 'info/event/base.html' %}
{% load date_and_time %}


{# EVENT DETAILS #}

{% block event_details %}
  <h4> {{ event.alert_type.name }} event </h4>
  <p>
    <small>{{ event.alert_type.description }}</small>
  </p>

  {% with ack=event.is_acknowledged %}
    {% if ack %}
      <div class="alert-box info">
        Acknowledged {{ ack.date }} by {{ ack.account.name }}
        {% if ack.comment %}
          <div>"{{ ack.comment }}"</div>
        {% endif %}
      </div>
    {% endif %}
  {% endwith %}

  <table class="vertitable full-width">
    <tbody>

      <tr>
        <th>Source</th>
        <td>{{ event.source }}</td>
      </tr>


      {% if event.is_stateful %}
        <tr>
          <th>Start</th>
          <td>{{ event.start_time }}</td>
        </tr>

        <tr>
          <th>End</th>
          <td>
            {% if event.is_open %}
              Still active
            {% else %}
              {{ event.end_time }}
            {% endif %}
          </td>
        </tr>

        <tr>
          <th>Duration</th>
          <td>{{ event.get_downtime|remove_microseconds }}</td>
        </tr>

      {% else %}

        <tr>
          <th>Issued</th>
          <td>{{ event.start_time }}</td>
        </tr>

      {% endif %}

      {% with subject=event.get_subject %}
        <tr>
          <th>Subject</th>
          <td>
            {% with subject_url=subject.get_absolute_url %}
              {% if subject_url %}
                <a href="{{ subject_url }}">{{ subject }}</a>
              {% else %}
                {{ subject }}
              {% endif %}
            {% endwith %}
          </td>
        </tr>
      {% endwith %}
    </tbody>
  </table>
{% endblock %}


{# EVENT MESSAGES #}

{% block event_messages %}
  <h4>Alerts that were sent</h4>
  {% for alert in event.alertqueue_set.all %}
    <div>
      {{ alert.time }}
      <ul class="alert-recipient-list" style="margin-bottom: .5rem">
        {% for accountalert in alert.accountalertqueue_set.all %}
          <li>
            <span data-tooltip title="{{ accountalert.subscription.alert_address.address }}" class="has-tip">
              {{ accountalert.account.name }}
            </span>
            got
            <span>
              {{ accountalert.subscription.alert_address.type.name|lower }}
            </span>
          </li>
        {% endfor %}
      </ul>

      <button class="tiny secondary toggle-messages">Show alert messages</button>
      <div class="alert-message-container" style="display: none">
        {% for message in alert.messages.all %}
          <dl>
            <dt>{{ message.type }}</dt>
            <dd>
              {{ message.message|linebreaks }}
            </dd>
          </dl>
        {% endfor %}
      </div>
    </div>
  {% empty %}
    <p>No alerts were sent</p>
  {% endfor %}

{% endblock %}


{# ACTIONS #}

{% block user_actions %}
  <h4>Available actions</h4>

  <select id="action-chooser" name="action">
    <option value="">----------</option>
    <option value="actions-acknowledge">Acknowledge alert</option>
    {% if event.is_open %}
      <option value="actions-resolve">Clear alert</option>
    {% endif %}
    {% if event.get_subject.pk %}
      <option value="actions-maintenance">Put on maintenance</option>
    {% endif %}
    <option value="actions-delete">Delete module or chassis</option>
  </select>

  {# Acknowledge alert #}
  <div id="actions-acknowledge" class="action-container">
    <form action="{% url 'status2_acknowledge_alert' %}">
      <input type="hidden" name="id[]" value="{{ event.pk }}" />

      <label>
        Description
        <input type="text" name="description" placeholder="" />
      </label>

      <a data-dropdown="acknowledge-info" aria-controls="acknowledge-info" aria-expanded="false">About acknowledging</a>

      <input type="submit" class="button small secondary right" value="Acknowledge alert" />
    </form>

    <div id="acknowledge-info" data-dropdown-content class="f-dropdown content small" aria-hidden="true" tabindex="-1">
      <h5>About acknowledging</h5>

      <p>
        Acknowledged alerts will be hidden for all users, but not removed. When
        an end event arrives the alert will be cleared normally.
      </p>
    </div>

  </div>

  {# Resolve/clear alert #}
  <div id="actions-resolve" class="action-container">
    <form action="{% url 'status2_clear_alert' %}">
      <input type="hidden" name="id[]" value="{{ event.pk }}" />
      <a data-dropdown="resolve-info" aria-controls="resolve-info" aria-expanded="false">About clearing alerts</a>
      <input type="submit" class="button small secondary right" value="Clear alert" />
    </form>

    <div id="resolve-info" data-dropdown-content class="f-dropdown content small" aria-hidden="true" tabindex="-1">
      <h5>About clearing alerts</h5>

      <p>
        Clearing an alert will set its end time, thereby closing it and removing
        it from the list of problems. Use this to remove alerts that have become
        invalid, where there is no way for NAV to automatically detect this.
      </p>

      <p>
        Be aware that if the root cause of the alert is still there, NAV may end
        up posting a new alert for the same issue.
      </p>
    </div>

  </div>

  {# Put on maintenance #}
  <div id="actions-maintenance" class="action-container">
    <form action="{% url 'status2_put_on_maintenance' %}">
      <input type="hidden" name="id[]" value="{{ event.pk }}" />
      <label>
        Description
        <input type="text" name="description" placeholder="" />
      </label>
      <input type="submit" class="button small secondary right" value="Put on maintenance" />
    </form>

    <a data-dropdown="maintenance-info" aria-controls="maintenance-info" aria-expanded="false">
      About putting on maintenance
    </a>

    <div id="maintenance-info" data-dropdown-content class="f-dropdown content small" aria-hidden="true" tabindex="-1">
      <h5>Put on maintenance</h5>

      <p>
        Putting an alert on maintenance only makes sense if the subject can be
        put on maintenance, for instance IP Devices and Services.
      </p>

    </div>

  </div>

  {# Delete module or chassis #}
  <div id="actions-delete" class="action-container">
    <form action="{% url 'status2_delete_module_or_chassis' %}">
      <input type="hidden" name="id[]" value="{{ event.pk }}" />
      <input type="submit" class="button small secondary full-width" value="Delete module or chassis" />
    </form>

    <a data-dropdown="delete-info" aria-controls="delete-info" aria-expanded="false">
      About deleting module or chassis
    </a>

    <div id="delete-info" data-dropdown-content class="f-dropdown content small" aria-hidden="true" tabindex="-1">
      <h5>About deleting module or chassis</h5>

      <p>
        NAV does not know if a module or chassis that has disappeared did so
        because of an error or because it was removed on purpose. Thus, modules
        and chassis that disappear are all listed in status until manually
        deleted from NAV by a manual module/chassis delete.
      </p>

    </div>
  </div>

{% endblock %}


{% block footer_scripts %}
  <script>
   {# Toggle show alert messages #}
   $('.toggle-messages').on('click', function() {
       $(this).next().slideToggle() ;
   });

   {# Shows the correct action form #}
   $('#action-chooser').on('change', function() {
       $('.action-container').hide();
       $('#' + this.value).show();
   });

   {# submits the action  #}
   $('.action-container form').on('submit', function(e) {
       e.preventDefault();
       var request = $.post(this.action, $(this).serialize());
       request.done(function() {
           window.location = {% url 'status2-index' %}
       })
       request.fail(function(error) {
           alert('Error submitting form');
       });
   });

   {# Fetches any custom alert template and displays it #}
   var request = $.ajax('/api/1/alert/{{event.pk}}', {
       method: 'GET',
       headers: {Accept: 'text/x-nav-html'}
   });
   request.done(function(response) {
       if (response) {
           $('.navbody').append($('<div class="panel white">').html(response));
       }
   });
  </script>
{% endblock %}
